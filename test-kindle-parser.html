<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kindle Parser Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        .test-area { 
            margin: 20px 0; 
        }
        textarea { 
            width: 100%; 
            height: 200px; 
            margin: 10px 0; 
            font-family: monospace;
        }
        .results { 
            background: #f5f5f5; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 10px 0;
        }
        .error { 
            background: #ffe6e6; 
            color: #d00; 
            padding: 10px; 
            border-radius: 5px; 
        }
        button { 
            padding: 10px 20px; 
            font-size: 16px; 
            cursor: pointer; 
        }
    </style>
</head>
<body>
    <h1>Kindle Parser Test</h1>
    
    <div class="test-area">
        <h2>Test Kindle Text Parsing</h2>
        <p>Paste your Kindle clippings below and click "Parse" to test:</p>
        
        <textarea id="kindleText" placeholder="Paste your Kindle clippings text here...">The Great Gatsby (F. Scott Fitzgerald)
- Your Highlight on page 180 | location 2740-2741 | Added on Monday, January 1, 2024 10:30:00 AM

So we beat on, boats against the current, borne back ceaselessly into the past.

The Great Gatsby (F. Scott Fitzgerald)
- Your Note on page 95 | location 1456 | Added on Monday, January 1, 2024 11:45:00 AM

This is a personal note I wrote about this passage.

1984 (George Orwell)
- Your Highlight on page 1 | location 15-16 | Added on Tuesday, January 2, 2024 9:00:00 AM

It was a bright cold day in April, and the clocks were striking thirteen.</textarea>
        
        <br>
        <button onclick="testParsing()">Parse Kindle Text</button>
        
        <div id="results"></div>
    </div>

    <script>
        // Basic parser logic for testing
        class SimpleKindleParser {
            parseText(content) {
                try {
                    const entries = this.splitIntoEntries(content);
                    const results = [];
                    const errors = [];
                    
                    for (let i = 0; i < entries.length; i++) {
                        try {
                            const parsed = this.parseEntry(entries[i], i);
                            if (parsed) results.push(parsed);
                        } catch (error) {
                            errors.push(`Entry ${i}: ${error.message}`);
                        }
                    }
                    
                    return { results, errors };
                } catch (error) {
                    return { results: [], errors: [error.message] };
                }
            }
            
            splitIntoEntries(content) {
                const normalized = content.replace(/\r\n/g, '\n');
                const entries = normalized.split(/(?=^.+\([^)]+\)$)|(?=^-\s*Your\s+(?:Highlight|Note|Bookmark))/m);
                return entries.filter(entry => entry.trim().length > 0);
            }
            
            parseEntry(entryText, index) {
                const entry = entryText.trim();
                if (!entry) return null;
                
                const lines = entry.split('\n').map(line => line.trim()).filter(line => line);
                if (lines.length < 2) return null;

                const firstLine = lines[0];
                const bookInfo = this.extractBookInfo(firstLine);
                
                if (bookInfo) {
                    if (lines.length < 3) return null;
                    
                    const metadataLine = lines[1];
                    const metadata = this.extractMetadata(metadataLine);
                    if (!metadata) return null;

                    const content = lines.slice(2).join('\n').trim();
                    
                    return {
                        book: bookInfo,
                        metadata,
                        content: content || '',
                        index
                    };
                }
                return null;
            }
            
            extractBookInfo(line) {
                const patterns = [
                    /^(.+?)\s*\(([^)]+)\)$/, // "Title (Author)"
                    /^(.+?)\s*-\s*(.+)$/, // "Title - Author"
                    /^(.+?)\s*by\s+(.+)$/i, // "Title by Author"
                ];

                for (const pattern of patterns) {
                    const match = line.match(pattern);
                    if (match) {
                        return {
                            title: match[1].trim(),
                            author: match[2].trim()
                        };
                    }
                }
                return null;
            }
            
            extractMetadata(line) {
                const patterns = [
                    /^-\s*Your\s+(Highlight|Note|Bookmark)\s+(?:on\s+(?:page\s+\d+\s*\|?\s*)?(?:location\s+)?([^|]+?))?\s*\|\s*Added\s+on\s+(.+?)$/i,
                    /^-\s*Your\s+(Highlight|Note|Bookmark)\s+at\s+location\s+([^|]+)\s*\|\s*Added\s+on\s+(.+?)$/i,
                    /^-\s*(Highlight|Note|Bookmark)\s+on\s+(?:page\s+\d+\s*\|?\s*)?(?:location\s+)?([^|]+?)\s*\|\s*(.+?)$/i,
                ];

                for (const pattern of patterns) {
                    const match = line.match(pattern);
                    if (match) {
                        try {
                            return {
                                type: match[1].toLowerCase(),
                                location: match[2]?.trim() || 'Unknown',
                                timestamp: new Date(match[3].trim())
                            };
                        } catch (error) {
                            continue;
                        }
                    }
                }
                return null;
            }
        }
        
        function testParsing() {
            const text = document.getElementById('kindleText').value;
            const resultsDiv = document.getElementById('results');
            
            if (!text.trim()) {
                resultsDiv.innerHTML = '<div class="error">Please enter some text to parse</div>';
                return;
            }
            
            try {
                const parser = new SimpleKindleParser();
                const result = parser.parseText(text);
                
                let html = '<div class="results">';
                html += `<h3>Parsing Results</h3>`;
                html += `<p><strong>Entries found:</strong> ${result.results.length}</p>`;
                
                if (result.errors.length > 0) {
                    html += '<h4>Errors:</h4><ul>';
                    result.errors.forEach(error => {
                        html += `<li>${error}</li>`;
                    });
                    html += '</ul>';
                }
                
                if (result.results.length > 0) {
                    html += '<h4>Parsed Entries:</h4>';
                    result.results.forEach((entry, index) => {
                        html += `
                            <div style="border: 1px solid #ddd; margin: 10px 0; padding: 10px; background: white;">
                                <strong>Entry ${index + 1}:</strong><br>
                                <strong>Book:</strong> ${entry.book.title} by ${entry.book.author}<br>
                                <strong>Type:</strong> ${entry.metadata.type}<br>
                                <strong>Location:</strong> ${entry.metadata.location}<br>
                                <strong>Date:</strong> ${entry.metadata.timestamp.toLocaleString()}<br>
                                <strong>Content:</strong> ${entry.content}
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Parsing failed: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>