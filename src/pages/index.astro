---
// Library page showing organized books and notes
import BaseLayout from "../layouts/BaseLayout.astro";
import BookCard from "../components/notes/BookCard.astro";
import NoteCard from "../components/notes/NoteCard.astro";
import RandomSuggestionCard from "../components/sharing/RandomSuggestionCard.astro";
import EmptyState from "../components/common/EmptyState.astro";
import { getAllBooks, getAllNotes } from "../lib/server/storage";
import {
  selectRandomSuggestion,
  toSuggestionPool,
} from "../lib/export/random-suggestion";

// Load all data at build time
const allBooks = await getAllBooks();
const allNotes = await getAllNotes();

// Compute note counts per book
const noteCountMap = new Map<string, number>();
for (const note of allNotes) {
  noteCountMap.set(note.bookId, (noteCountMap.get(note.bookId) || 0) + 1);
}

// Add note counts to books and sort by most recent first
const booksWithCounts = allBooks
  .map((book) => ({
    ...book,
    noteCount: noteCountMap.get(book.id) || 0,
  }))
  .sort((a, b) => {
    const dateA = new Date(a.lastModifiedAt || a.createdAt).getTime();
    const dateB = new Date(b.lastModifiedAt || b.createdAt).getTime();
    return dateB - dateA;
  });

// Get recent notes (last 10)
const recentNotes = [...allNotes]
  .sort(
    (a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime(),
  )
  .slice(0, 10);

// Compute statistics
const stats = {
  totalBooks: allBooks.length,
  totalNotes: allNotes.length,
  totalHighlights: allNotes.filter((n) => n.type === "highlight").length,
  favoriteNotes: 0, // Future feature
};

const hasContent = allBooks.length > 0;
const suggestionPool = toSuggestionPool(allNotes, allBooks);
const initialSuggestion = selectRandomSuggestion(suggestionPool);
---

<BaseLayout
  title="My Library"
  description="Browse and organize your Kindle highlights, notes, and bookmarks"
>
  <main class="library">
    <header class="library-header">
      <div class="header-content">
        <h1 class="library-title">My Library</h1>
        <p class="library-description">
          Your collection of books, highlights, and insights
        </p>
      </div>

      <div class="header-actions">
        <a href="/search" class="btn btn-primary">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <circle cx="11" cy="11" r="8"></circle>
            <path d="M21 21l-4.35-4.35"></path>
          </svg>
          Search
        </a>
      </div>
    </header>

    {
      hasContent && (
        <div class="library-stats">
          <div class="stat">
            <div class="stat-value">{stats.totalBooks}</div>
            <div class="stat-label">Books</div>
          </div>
          <div class="stat">
            <div class="stat-value">{stats.totalNotes}</div>
            <div class="stat-label">Notes</div>
          </div>
          <div class="stat">
            <div class="stat-value">{stats.totalHighlights}</div>
            <div class="stat-label">Highlights</div>
          </div>
          <div class="stat">
            <div class="stat-value">{stats.favoriteNotes}</div>
            <div class="stat-label">Favorites</div>
          </div>
        </div>
      )
    }

    <div class="library-content">
      {
        !hasContent ? (
          <EmptyState
            title="No Books Yet"
            message="Start building your library by importing your Kindle clippings file."
            icon="books"
            action={{
              text: "Import Books",
              href: "/",
            }}
          />
        ) : (
          <>
            <RandomSuggestionCard suggestion={initialSuggestion} />

            {/* Books section */}
            <section class="books-section">
              <div class="section-header">
                <h2 class="section-title">My Books</h2>
                <div class="section-actions">
                  <span class="book-count">
                    {stats.totalBooks}{" "}
                    {stats.totalBooks === 1 ? "book" : "books"}
                  </span>
                </div>
              </div>

              <div class="books-grid">
                {booksWithCounts.map((book) => (
                  <BookCard book={book} noteCount={book.noteCount} />
                ))}
              </div>
            </section>

            {/* Recent notes section */}
            {recentNotes.length > 0 && (
              <section class="notes-section">
                <div class="section-header">
                  <h2 class="section-title">Recent Notes</h2>
                  <a href="/search?type=notes" class="section-link">
                    View All
                  </a>
                </div>

                <div class="notes-list">
                  {recentNotes.map((note) => {
                    const book = allBooks.find((b) => b.id === note.bookId);
                    return (
                      <NoteCard
                        note={note}
                        bookTitle={book?.title}
                        bookAuthor={book?.author}
                      />
                    );
                  })}
                </div>
              </section>
            )}
          </>
        )
      }
    </div>
  </main>
</BaseLayout>

<style>
  .library {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 var(--space-md);
  }

  .library-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-xl);
    padding: var(--space-xl);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-lg);
    background: var(--color-surface);
  }

  .header-content {
    flex: 1;
  }

  .library-title {
    font-family: var(--font-family-primary);
    font-size: clamp(1.8rem, 4vw, 2.6rem);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
    margin: 0 0 var(--space-sm);
  }

  .library-description {
    font-family: var(--font-family-secondary);
    font-size: var(--font-size-lg);
    color: var(--color-text-secondary);
    margin: 0;
    max-width: 38rem;
  }

  .header-actions {
    display: flex;
    gap: var(--space-sm);
    align-items: center;
  }

  .header-actions .btn svg {
    width: 20px;
    height: 20px;
    margin-right: var(--space-xs);
  }

  .library-stats {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: var(--space-md);
    margin-bottom: var(--space-2xl);
    padding: 0;
  }

  .stat {
    text-align: left;
    padding: var(--space-lg);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-lg);
    background: var(--color-surface);
  }

  .stat-value {
    font-family: var(--font-family-secondary);
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary);
    display: block;
    line-height: 1;
  }

  .stat-label {
    font-family: var(--font-family-secondary);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin-top: var(--space-xs);
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
  }

  .section-title {
    font-family: var(--font-family-secondary);
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
    margin: 0;
  }

  .section-actions {
    display: flex;
    gap: var(--space-sm);
    align-items: center;
  }

  .book-count {
    font-family: var(--font-family-secondary);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    font-weight: var(--font-weight-medium);
  }

  .section-link {
    font-family: var(--font-family-secondary);
    color: var(--color-primary);
    text-decoration: none;
    font-weight: var(--font-weight-medium);
    transition: color 0.2s var(--easing-ease-out);
  }

  .section-link:hover {
    color: var(--color-primary-dark);
  }

  .books-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--space-lg);
    margin-bottom: var(--space-2xl);
  }

  .notes-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .notes-section {
    margin-top: var(--space-2xl);
    padding: var(--space-xl);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-lg);
    background: var(--color-surface);
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .library {
      padding: 0;
    }

    .library-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-lg);
      padding: var(--space-lg);
    }

    .header-actions {
      width: 100%;
    }

    .library-stats {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .books-grid {
      grid-template-columns: 1fr;
    }

    .section-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-sm);
    }
  }
</style>
