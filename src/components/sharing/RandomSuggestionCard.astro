---
import type { RandomSuggestion } from "../../lib/types";

export interface Props {
  suggestion: RandomSuggestion | null;
  suggestionPool?: RandomSuggestion[];
}

const { suggestion, suggestionPool = [] } = Astro.props;
---

<section
  class="random-suggestion"
  aria-labelledby="randomSuggestionTitle"
  data-suggestion-pool={encodeURIComponent(JSON.stringify(suggestionPool))}
>
  <div class="suggestion-header">
    <h2 id="randomSuggestionTitle">Random spark</h2>
    {suggestion && <span class="suggestion-type">{suggestion.itemType}</span>}
  </div>

  {
    suggestion ? (
      <div
        class="suggestion-body"
        data-suggestion-id={suggestion.itemId}
        data-suggestion-type={suggestion.itemType}
        data-suggestion-title={suggestion.bookTitle}
        data-full-text={suggestion.fullText}
        data-preview-text={suggestion.previewText}
        data-associated-highlight-text={
          suggestion.associatedHighlightText || ""
        }
        data-full-associated-highlight-text={
          suggestion.fullAssociatedHighlightText || ""
        }
      >
        {suggestion.itemType === "note" &&
          suggestion.fullAssociatedHighlightText && (
            <p class="suggestion-highlight">
              "{suggestion.fullAssociatedHighlightText}"
            </p>
          )}
        <p class="suggestion-text">
          {suggestion.itemType === "note" ? "Note: " : ""}
          {`"${suggestion.fullText}"`}
        </p>
        <p class="suggestion-attribution">
          — {suggestion.bookTitle.split("(Z-Library")[0]}
        </p>
        <div class="suggestion-actions">
          <button
            type="button"
            class="btn btn-primary"
            onclick="copyFullText()"
          >
            Copy Full
          </button>
          <button
            type="button"
            class="btn btn-secondary"
            onclick="copySummary()"
          >
            Copy Summary
          </button>
          <button
            type="button"
            class="btn btn-ghost"
            onclick="refreshRandomSuggestion()"
          >
            New suggestion
          </button>
        </div>
      </div>
    ) : (
      <div class="suggestion-empty" id="suggestionEmpty">
        No notes or highlights yet. Import a book to get a shareable suggestion.
      </div>
    )
  }
</section>

<script>
  // Keep track of suggestion IDs we've shown so we can exclude them
  const excludedSuggestionIds = new Set<string>();
  const suggestionContainer = document.querySelector(
    ".random-suggestion",
  ) as HTMLElement | null;
  const rawPool = suggestionContainer?.dataset.suggestionPool || "";
  let allSuggestions: Array<{ itemId: string }> = [];
  try {
    allSuggestions = rawPool
      ? (JSON.parse(decodeURIComponent(rawPool)) as Array<{ itemId: string }>)
      : [];
  } catch {
    allSuggestions = [];
  }

  function buildSuggestionShareText(card: HTMLElement): string {
    const primary =
      card.querySelector(".suggestion-highlight")?.textContent?.trim() || "";
    const secondary =
      card.querySelector(".suggestion-text")?.textContent?.trim() || "";
    const attribution =
      card.querySelector(".suggestion-attribution")?.textContent?.trim() || "";
    return [primary, secondary, attribution].filter(Boolean).join("\n");
  }

  async function copyFullText() {
    const card = document.querySelector(
      "[data-suggestion-id]",
    ) as HTMLElement | null;
    if (!card) {
      showSuggestionToast("No suggestion available to copy.", "error");
      return;
    }

    const fullText = card.dataset.fullText || "";
    const fullHighlight = card.dataset.fullAssociatedHighlightText || "";
    const title = card.dataset.suggestionTitle || "";
    const cleanTitle = title.split("(Z-Library")[0].trim();
    
    const parts = [];
    if (fullHighlight) parts.push(`"${fullHighlight}"`);
    if (fullText) {
      const prefix = card.dataset.suggestionType === "note" ? "Note: " : "";
      parts.push(`${prefix}"${fullText}"`);
    }
    if (cleanTitle) parts.push(`— ${cleanTitle}`);
    
    const shareText = parts.join("\n");
    if (!shareText) {
      showSuggestionToast("No suggestion text available to share.", "error");
      return;
    }

    try {
      const shareData = {
        title: `From ${card.dataset.suggestionTitle || "my reading"}`,
        text: shareText,
      };

      if (navigator.share) {
        await navigator.share(shareData);
        showSuggestionToast("Share opened successfully.", "success");
      } else {
        try {
          await navigator.clipboard.writeText(shareText);
          showSuggestionToast(
            "Full text copied to clipboard!",
            "success",
          );
        } catch (clipboardError) {
          try {
            const ta = document.createElement("textarea");
            ta.value = shareText;
            ta.setAttribute("readonly", "");
            ta.style.position = "fixed";
            ta.style.opacity = "0";
            document.body.appendChild(ta);
            ta.select();
            const ok = document.execCommand("copy");
            ta.remove();
            if (ok) {
              showSuggestionToast(
                "Full text copied to clipboard!",
                "success",
              );
            } else {
              throw clipboardError || new Error("Clipboard copy failed");
            }
          } catch (fallbackError) {
            throw fallbackError;
          }
        }
      }
    } catch (error) {
      console.error(error);
      showSuggestionToast("Failed to copy full text.", "error");
    }
  }

  async function copySummary() {
    const card = document.querySelector(
      "[data-suggestion-id]",
    ) as HTMLElement | null;
    if (!card) {
      showSuggestionToast("No suggestion available to copy.", "error");
      return;
    }

    const previewText = card.dataset.previewText || "";
    const previewHighlight = card.dataset.associatedHighlightText || "";
    const title = card.dataset.suggestionTitle || "";
    const cleanTitle = title.split("(Z-Library")[0].trim();
    
    const parts = [];
    if (previewHighlight) parts.push(`"${previewHighlight}"`);
    if (previewText) {
      const prefix = card.dataset.suggestionType === "note" ? "Note: " : "";
      parts.push(`${prefix}"${previewText}"`);
    }
    if (cleanTitle) parts.push(`— ${cleanTitle}`);
    
    const shareText = parts.join("\n");
    if (!shareText) {
      showSuggestionToast("No suggestion text available to copy.", "error");
      return;
    }

    try {
      const shareData = {
        title: `From ${card.dataset.suggestionTitle || "my reading"}`,
        text: shareText,
      };

      if (navigator.share) {
        await navigator.share(shareData);
        showSuggestionToast("Share opened successfully.", "success");
      } else {
        try {
          await navigator.clipboard.writeText(shareText);
          showSuggestionToast(
            "Summary copied to clipboard!",
            "success",
          );
        } catch (clipboardError) {
          try {
            const ta = document.createElement("textarea");
            ta.value = shareText;
            ta.setAttribute("readonly", "");
            ta.style.position = "fixed";
            ta.style.opacity = "0";
            document.body.appendChild(ta);
            ta.select();
            const ok = document.execCommand("copy");
            ta.remove();
            if (ok) {
              showSuggestionToast(
                "Summary copied to clipboard!",
                "success",
              );
            } else {
              throw clipboardError || new Error("Clipboard copy failed");
            }
          } catch (fallbackError) {
            throw fallbackError;
          }
        }
      }
    } catch (error) {
      console.error(error);
      showSuggestionToast("Failed to copy summary.", "error");
    }
  }

  async function refreshRandomSuggestion() {
    const current = document.querySelector(
      "[data-suggestion-id]",
    ) as HTMLElement | null;
    const currentId = current?.dataset.suggestionId;
    if (currentId) excludedSuggestionIds.add(currentId);

    console.debug(
      "refreshRandomSuggestion - excludedIds:",
      Array.from(excludedSuggestionIds),
    );

    try {
      const candidates = allSuggestions.filter(
        (item) => !excludedSuggestionIds.has(String(item.itemId)),
      );

      if (!candidates.length) {
        console.debug(
          "refreshRandomSuggestion - no more suggestions in local pool",
        );
        renderEmptySuggestion();
        return;
      }

      const index = Math.floor(Math.random() * candidates.length);
      const suggestion = candidates[index];
      console.debug("refreshRandomSuggestion - new suggestion:", suggestion);
      // Add the returned suggestion id to the excluded set so we don't show it again
      if (suggestion?.itemId)
        excludedSuggestionIds.add(String(suggestion.itemId));
      renderSuggestion(suggestion);
      showSuggestionToast("New suggestion ready.", "success");
    } catch (error) {
      console.error("refreshRandomSuggestion - error:", error);
      showSuggestionToast("Failed to load a new suggestion.", "error");
    }
  }

  function renderSuggestion(suggestion: any) {
    const container = document.querySelector(".random-suggestion");
    if (!container) return;

    const escapedText = String(suggestion.fullText || "").replace(
      /"/g,
      "&quot;",
    );
    const escapedFullHighlight = String(suggestion.fullAssociatedHighlightText || "").replace(
      /"/g,
      "&quot;",
    );
    const authorPart = suggestion.bookAuthor
      ? `, ${suggestion.bookAuthor}`
      : "";
    // Strip '(Z-Library' and anything after from bookTitle for attribution
    const cleanBookTitle = suggestion.bookTitle.split("(Z-Library")[0];

    const body = container.querySelector(
      ".suggestion-body",
    ) as HTMLElement | null;
    const empty = container.querySelector(
      ".suggestion-empty",
    ) as HTMLElement | null;

    if (empty) {
      empty.remove();
    }

    if (!body) {
      const wrapper = document.createElement("div");
      wrapper.className = "suggestion-body";
      wrapper.innerHTML = `
        ${
          suggestion.itemType === "note" && suggestion.fullAssociatedHighlightText
            ? `<p class="suggestion-highlight">"${escapedFullHighlight}"</p>`
            : ""
        }
        <p class="suggestion-text">${suggestion.itemType === "note" ? "Note: " : ""}"${escapedText}"</p>
        <p class="suggestion-attribution">— ${cleanBookTitle}${authorPart}</p>
        <div class="suggestion-actions">
          <button type="button" class="btn btn-primary" onclick="copyFullText()">Copy Full</button>
          <button type="button" class="btn btn-secondary" onclick="copySummary()">Copy Summary</button>
          <button type="button" class="btn btn-ghost" onclick="refreshRandomSuggestion()">New suggestion</button>
        </div>
      `;
      wrapper.setAttribute("data-suggestion-id", suggestion.itemId);
      wrapper.setAttribute("data-suggestion-type", suggestion.itemType);
      wrapper.setAttribute("data-suggestion-title", suggestion.bookTitle);
      wrapper.setAttribute("data-full-text", suggestion.fullText || "");
      wrapper.setAttribute("data-preview-text", suggestion.previewText || "");
      wrapper.setAttribute(
        "data-associated-highlight-text",
        suggestion.associatedHighlightText || "",
      );
      wrapper.setAttribute(
        "data-full-associated-highlight-text",
        suggestion.fullAssociatedHighlightText || "",
      );
      container.appendChild(wrapper);
    } else {
      body.setAttribute("data-suggestion-id", suggestion.itemId);
      body.setAttribute("data-suggestion-type", suggestion.itemType);
      body.setAttribute("data-suggestion-title", suggestion.bookTitle);
      body.setAttribute("data-full-text", suggestion.fullText || "");
      body.setAttribute("data-preview-text", suggestion.previewText || "");
      body.setAttribute(
        "data-associated-highlight-text",
        suggestion.associatedHighlightText || "",
      );
      body.setAttribute(
        "data-full-associated-highlight-text",
        suggestion.fullAssociatedHighlightText || "",
      );
      const textNode = body.querySelector(".suggestion-text");
      if (textNode)
        textNode.textContent = `${suggestion.itemType === "note" ? "Note: " : ""}"${suggestion.fullText}"`;
      let highlightNode = body.querySelector(".suggestion-highlight");
      if (
        suggestion.itemType === "note" &&
        suggestion.fullAssociatedHighlightText
      ) {
        if (!highlightNode) {
          highlightNode = document.createElement("p");
          highlightNode.className = "suggestion-highlight";
          // Insert highlight before note text
          textNode?.parentNode?.insertBefore(highlightNode, textNode);
        }
        highlightNode.textContent = `"${suggestion.fullAssociatedHighlightText}"`;
      } else if (highlightNode) {
        highlightNode.remove();
      }
      const attributionNode = body.querySelector(".suggestion-attribution");
      if (attributionNode)
        attributionNode.textContent = `— ${cleanBookTitle}${authorPart}`;
    }

    const typeBadge = container.querySelector(".suggestion-type");
    if (typeBadge) {
      typeBadge.textContent = suggestion.itemType;
    }
  }

  function renderEmptySuggestion() {
    const container = document.querySelector(".random-suggestion");
    if (!container) return;

    const body = container.querySelector(".suggestion-body");
    if (body) body.remove();

    const typeBadge = container.querySelector(".suggestion-type");
    if (typeBadge) typeBadge.remove();

    const empty = document.createElement("div");
    empty.className = "suggestion-empty";
    empty.textContent = "No notes or highlights available right now.";
    container.appendChild(empty);
  }

  function showSuggestionToast(message: string, type: "success" | "error") {
    const toast = document.createElement("div");
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 16px;
      border-radius: 8px;
      z-index: 1000;
      font-family: var(--font-family-secondary);
      font-size: var(--font-size-sm);
      background: ${type === "success" ? "var(--color-success)" : "var(--color-error)"};
      color: white;
    `;

    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  (window as any).copyFullText = copyFullText;
  (window as any).copySummary = copySummary;
  (window as any).refreshRandomSuggestion = refreshRandomSuggestion;
</script>

<style>
  .random-suggestion {
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-lg);
    background: var(--color-surface);
    padding: var(--space-lg);
    margin-bottom: var(--space-xl);
  }

  .suggestion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
  }

  .suggestion-header h2 {
    margin: 0;
    font-size: var(--font-size-lg);
  }

  .suggestion-type {
    font-size: var(--font-size-xs);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--color-text-secondary);
  }

  .suggestion-text {
    margin: 0 0 var(--space-sm);
    font-size: var(--font-size-md);
    color: var(--color-text-primary);
  }

  .suggestion-attribution {
    margin: 0 0 var(--space-md);
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
  }

  .suggestion-highlight {
    margin: 0 0 var(--space-sm);
    color: var(--color-text-primary);
    font-size: var(--font-size-sm);
    opacity: 0.9;
  }

  .suggestion-actions {
    display: flex;
    gap: var(--space-sm);
    flex-wrap: wrap;
  }

  .suggestion-empty {
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
  }
</style>
