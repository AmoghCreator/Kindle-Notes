---
// Book card component for displaying book information
import type { Book } from "../../lib/types";

export interface Props {
  book: Book;
  noteCount?: number;
  showActions?: boolean;
  compact?: boolean;
  class?: string;
}

const {
  book,
  noteCount = 0,
  showActions = true,
  compact = false,
  class: className = "",
} = Astro.props;

const bookUrl = `/books/${book.id}`;

// Convert date strings to Date objects (JSON deserialization gives us strings)
const createdAtDate = book.createdAt ? new Date(book.createdAt) : null;
---

<article
  class={`book-card ${compact ? "book-card-compact" : ""} ${className}`}
  data-book-id={book.id}
>
  <div class="book-content">
    <div class="book-cover" data-cover-container>
      {
        book.cover ? (
          <img src={book.cover} alt={`Cover of ${book.title}`} loading="lazy" />
        ) : (
          <div class="book-cover-placeholder" data-cover-placeholder>
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
              <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />
            </svg>
          </div>
        )
      }
    </div>
    <div class="book-details">
      <header class="book-header">
        <h3 class="book-title">
          <a href={bookUrl}>{book.title.split("(Z")[0]}</a>
        </h3>
        <p class="book-author">{book.author}</p>
      </header>

      <div class="book-stats">
        <span class="notes-count">
          <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
            <path
              d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
            ></path>
          </svg>
          {noteCount}
          {noteCount === 1 ? "note" : "notes"}
        </span>

        {
          !compact && createdAtDate && (
            <span class="added-date">
              Added{" "}
              {new Intl.DateTimeFormat("en-US", {
                month: "short",
                day: "numeric",
                year:
                  createdAtDate.getFullYear() !== new Date().getFullYear()
                    ? "numeric"
                    : undefined,
              }).format(createdAtDate)}
            </span>
          )
        }
      </div>
    </div>
  </div>
  {
    showActions && (
      <div class="book-actions">
        <a href={bookUrl} class="btn btn-sm btn-primary">
          View Notes
        </a>
        {!compact && (
          <button
            class="btn btn-sm btn-ghost"
            onclick={`shareBook('${book.id}')`}
            aria-label="Share book"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              width="16"
              height="16"
            >
              <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8" />
              <polyline points="16,6 12,2 8,6" />
              <line x1="12" y1="2" x2="12" y2="15" />
            </svg>
            Share
          </button>
        )}
      </div>
    )
  }
</article>

<script>
  async function fetchBookCover(bookId: string, container: Element) {
    const placeholder = container.querySelector("[data-cover-placeholder]");
    if (!placeholder) return; // Already has a cover

    try {
      const response = await fetch("/api/book-cover", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ bookId }),
      });

      const data = await response.json();

      if (data.success && data.cover) {
        // Replace placeholder with actual image
        const img = document.createElement("img");
        img.src = data.cover;
        img.alt = "Book cover";
        img.loading = "lazy";
        placeholder.replaceWith(img);
      }
    } catch (error) {
      console.error("Failed to fetch book cover:", error);
    }
  }

  function shareBook(bookId: string) {
    if (navigator.share) {
      navigator
        .share({
          title: "Check out my book notes",
          url: `${window.location.origin}/books/${bookId}`,
        })
        .catch(console.error);
    } else {
      // Fallback: copy to clipboard
      navigator.clipboard
        .writeText(`${window.location.origin}/books/${bookId}`)
        .then(() => {
          // Show toast notification
          const toast = document.createElement("div");
          toast.textContent = "Link copied to clipboard!";
          toast.style.cssText =
            "position: fixed; top: 20px; right: 20px; background: var(--color-success); color: white; padding: 12px 16px; border-radius: 8px; z-index: 1000;";
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 3000);
        })
        .catch(console.error);
    }
  }

  // Make function globally available
  (window as any).shareBook = shareBook;

  // Fetch book covers on page load
  document.addEventListener("DOMContentLoaded", () => {
    const bookCards = document.querySelectorAll("[data-book-id]");
    bookCards.forEach((card) => {
      const bookId = card.getAttribute("data-book-id");
      const coverContainer = card.querySelector("[data-cover-container]");
      if (bookId && coverContainer) {
        fetchBookCover(bookId, coverContainer);
      }
    });
  });
</script>

<style>
  .book-card {
    background-color: var(--color-surface);
    background-image: var(--texture-paper);
    background-size: var(--texture-paper-size);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-lg);
    padding: var(--space-lg);
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    transition: all 0.2s var(--easing-ease-out);
  }

  .book-card:hover {
    border-color: var(--color-primary);
    transform: translateY(-1px);
  }

  .book-card-compact {
    padding: var(--space-md);
    gap: var(--space-sm);
  }

  .book-cover {
    flex-shrink: 0;
    width: 80px;
    height: 120px;
    border-radius: var(--border-radius);
    overflow: hidden;
    background: var(--color-surface-hover);
  }

  .book-card-compact .book-cover {
    width: 60px;
    height: 90px;
  }

  .book-cover img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .book-cover-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(
      135deg,
      var(--color-surface-hover) 0%,
      var(--color-border) 100%
    );
    color: var(--color-text-muted);
  }

  .book-cover-placeholder svg {
    width: 32px;
    height: 32px;
  }

  .book-content {
    flex: 1;
    display: flex;
    flex-direction: row;
    gap: var(--space-md);
    min-width: 0;
  }

  .book-header {
    margin-bottom: var(--space-sm);
  }

  .book-title {
    font-family: var(--font-family-secondary);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    margin: 0 0 var(--space-xs);
    line-height: var(--line-height-tight);
    letter-spacing: -0.01em;
  }

  .book-card-compact .book-title {
    font-size: var(--font-size-base);
  }

  .book-title a {
    color: var(--color-text-primary);
    text-decoration: none;
    transition: color 0.2s var(--easing-ease-out);
  }

  .book-title a:hover {
    color: var(--color-primary);
  }

  .book-author {
    font-family: var(--font-family-secondary);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin: 0;
  }

  .book-details {
    flex: 1;
    min-width: 0;
  }

  .book-description {
    font-family: var(--font-family-secondary);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    line-height: var(--line-height-relaxed);
    margin: 0 0 var(--space-sm);

    /* Truncate long descriptions */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .book-meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    font-family: var(--font-family-secondary);
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }

  .book-meta span:not(:last-child)::after {
    content: "â€¢";
    margin-left: var(--space-sm);
    color: var(--color-border);
  }

  .book-stats {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-sm);
    font-family: var(--font-family-secondary);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .notes-count {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }

  .book-actions {
    display: flex;
    gap: var(--space-sm);
    align-items: center;
    border-top: 1px solid var(--color-border);
    padding-top: var(--space-sm);
  }

  .book-actions .btn {
    letter-spacing: normal;
  }

  .book-actions .btn {
    flex-shrink: 0;
  }

  .book-actions .btn svg {
    margin-right: var(--space-xs);
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .book-card {
      padding: var(--space-md);
      gap: var(--space-sm);
    }

    .book-cover {
      width: 60px;
      height: 90px;
    }

    .book-title {
      font-size: var(--font-size-base);
    }

    .book-actions {
      flex-wrap: wrap;
    }

    .book-stats {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-xs);
    }
  }

  /* Dark mode adjustments */
  :global(.dark) .book-cover-placeholder {
    background: linear-gradient(
      135deg,
      var(--color-surface) 0%,
      var(--color-border) 100%
    );
  }
</style>
