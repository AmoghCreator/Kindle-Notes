---
// Note card component for displaying individual notes
import type { Note } from "../../lib/types";

export interface Props {
  note: Note;
  bookTitle?: string;
  bookAuthor?: string;
  showBookInfo?: boolean;
  compact?: boolean;
  editable?: boolean;
  class?: string;
  displayMode?: "standalone" | "associated"; // T015: Display mode for association styling
  associatedHighlight?: Note; // T016: Associated highlight for context
  hasAssociatedNote?: boolean; // Indicates if this highlight has a note attached
}

const {
  note,
  bookTitle,
  bookAuthor,
  showBookInfo = false,
  compact = false,
  editable = false,
  class: className = "",
  displayMode = "standalone", // T015: Default to standalone
  associatedHighlight,
  hasAssociatedNote = false,
} = Astro.props;

// Convert date strings to Date objects (JSON deserialization gives us strings)
const createdAtDate = note.createdAt ? new Date(note.createdAt) : new Date();

// Format the note creation date
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat("en-US", {
    month: "short",
    day: "numeric",
    year:
      date.getFullYear() !== new Date().getFullYear() ? "numeric" : undefined,
    hour: "numeric",
    minute: "2-digit",
  }).format(date);
};

// Get icon for note type
const getTypeIcon = (type: "highlight" | "note" | "bookmark") => {
  switch (type) {
    case "highlight":
      return "M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z";
    case "note":
      return "M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 011-1h1a2 2 0 100-4H7a1 1 0 01-1-1V8a1 1 0 011-1h3a1 1 0 001-1V4z";
    case "bookmark":
      return "M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z";
    default:
      return "";
  }
};

const typeIcon = getTypeIcon(note.type);

// T017: Build CSS classes based on display mode
const displayClass =
  displayMode === "associated" ? "note-associated" : "note-standalone";
const hasNoteClass = hasAssociatedNote ? "has-associated-note" : "";
const cardClasses = `note-card note-type-${note.type} ${displayClass} ${hasNoteClass} ${compact ? "note-card-compact" : ""} ${className}`;
const noteDisplayText = ((note as any).content || note.text || "") as string;
const associatedHighlightText = ((associatedHighlight as any)?.content ||
  associatedHighlight?.text ||
  "") as string;

// T024: Build ARIA label for associated notes
const ariaLabel =
  displayMode === "associated" && associatedHighlight
    ? `Note for highlight: ${associatedHighlight.text?.substring(0, 50) || "highlight"}${(associatedHighlight.text?.length || 0) > 50 ? "..." : ""}`
    : undefined;
---

<article
  class={cardClasses}
  role={displayMode === "associated" ? "complementary" : "article"}
  aria-label={ariaLabel}
  data-note-card-id={note.id}
  data-note-type={note.type}
  data-note-content={noteDisplayText}
  data-book-title={bookTitle || ""}
  data-book-author={bookAuthor || ""}
  data-associated-highlight-id={note.associatedHighlightId || ""}
  data-associated-highlight-text={associatedHighlightText}
>
  <header class="note-header">
    <div class="note-type">
      <svg
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path d={typeIcon}></path>
      </svg>
      <span class="note-type-label">{note.type}</span>
    </div>

    <div class="note-meta">
      {
        note.location?.page && (
          <span class="note-page">Page {note.location.page}</span>
        )
      }
      {
        note.location && note.location.start && (
          <span class="note-location">
            Location {note.location.start}
            {note.location.end && note.location.end !== note.location.start
              ? `-${note.location.end}`
              : ""}
          </span>
        )
      }
      <time class="note-date" datetime={createdAtDate.toISOString()}>
        {formatDate(createdAtDate)}
      </time>
    </div>
  </header>

  {
    showBookInfo && bookTitle && (
      <div class="note-book-info">
        <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
          <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
        </svg>
        <span class="book-title">{bookTitle}</span>
      </div>
    )
  }

  <div class="note-content">
    {
      note.type === "bookmark" ? (
        <p class="bookmark-placeholder">Bookmark saved</p>
      ) : (
        <div
          class="note-text"
          data-note-id={note.id}
          contenteditable={editable}
        >
          {noteDisplayText}
        </div>
      )
    }
  </div>

  {
    note.tags && note.tags.length > 0 && (
      <div class="note-tags">
        {note.tags.map((tag) => (
          <span class="tag">#{tag}</span>
        ))}
      </div>
    )
  }

  <footer class="note-actions">
    <button
      class="action-btn"
      onclick={`copyNote('${note.id}')`}
      aria-label="Copy note"
      title="Copy to clipboard"
    >
      <svg
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
      </svg>
    </button>

    <button
      class="action-btn"
      onclick={`shareNote('${note.id}')`}
      aria-label="Share note"
      title="Share note"
    >
      <svg
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"></path>
        <polyline points="16,6 12,2 8,6"></polyline>
        <line x1="12" y1="2" x2="12" y2="15"></line>
      </svg>
    </button>

    {
      editable && (
        <button
          class="action-btn"
          onclick={`editNote('${note.id}')`}
          aria-label="Edit note"
          title="Edit note"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" />
            <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" />
          </svg>
        </button>
      )
    }

    <div class="action-spacer"></div>

    <button
      class="action-btn favorite-btn"
      onclick={`toggleFavorite('${note.id}')`}
      aria-label="Toggle favorite"
      title="Add to favorites"
    >
      <svg
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <polygon
          points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"
        ></polygon>
      </svg>
    </button>
  </footer>
</article>

<script>
  import { buildShareText } from "../../lib/export/share-format";

  // Client-side actions for notes (no database dependency)

  function getCardForNote(noteId: string): HTMLElement | null {
    return document.querySelector(`[data-note-card-id="${noteId}"]`);
  }

  function getResolvedBookTitle(card: HTMLElement): string {
    const fromData = (card.dataset.bookTitle || "").trim();
    if (fromData) return fromData;

    const fromHeader =
      document.querySelector(".book-title")?.textContent?.trim() || "";
    if (fromHeader) return fromHeader;

    return "Unknown Book";
  }

  function getResolvedBookAuthor(card: HTMLElement): string | undefined {
    const fromData = (card.dataset.bookAuthor || "").trim();
    if (fromData) return fromData;

    const fromHeader =
      document.querySelector(".book-author")?.textContent?.trim() || "";
    return fromHeader || undefined;
  }

  async function copyText(text: string): Promise<void> {
    if (navigator.clipboard?.writeText) {
      await navigator.clipboard.writeText(text);
      return;
    }

    const textarea = document.createElement("textarea");
    textarea.value = text;
    textarea.setAttribute("readonly", "");
    textarea.style.position = "fixed";
    textarea.style.opacity = "0";
    textarea.style.pointerEvents = "none";
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();

    const success = document.execCommand("copy");
    textarea.remove();

    if (!success) {
      throw new Error("Clipboard copy is unavailable");
    }
  }

  async function getSharePayload(noteId: string, mode: "share" | "copy") {
    const card = getCardForNote(noteId);
    if (!card) {
      throw new Error("Note card not found");
    }

    const itemType = (
      card.dataset.noteType === "highlight" ? "highlight" : "note"
    ) as "highlight" | "note";

    const payloadItem = {
      itemId: noteId,
      itemType,
      text: card.dataset.noteContent || "",
      bookId: "",
      bookTitle: getResolvedBookTitle(card),
      bookAuthor: getResolvedBookAuthor(card),
      associatedHighlightId: card.dataset.associatedHighlightId || undefined,
      associatedHighlightText:
        card.dataset.associatedHighlightText || undefined,
    };

    return buildShareText(payloadItem, {
      mode,
      includeAssociatedHighlight: true,
      maxLength: 280,
    });
  }

  async function copyNote(noteId: string) {
    try {
      const payload = await getSharePayload(noteId, "copy");
      await copyText(payload.text);
      showToast("Formatted quote copied to clipboard!", "success");
    } catch (error) {
      showToast("Copy failed. Clipboard access may be blocked.", "error");
    }
  }

  async function shareNote(noteId: string) {
    const card = getCardForNote(noteId);
    if (card) {
      const payload = await getSharePayload(noteId, "share");
      const shareData = {
        title: `From ${card.dataset.bookTitle || "my reading"}`,
        text: payload.text,
        url: window.location.href,
      };

      if (navigator.share) {
        navigator
          .share(shareData)
          .then(() => showToast("Share opened successfully.", "success"))
          .catch(() => showToast("Share cancelled or unavailable.", "error"));
      } else {
        copyText(shareData.text)
          .then(() => {
            showToast("Formatted share text copied to clipboard!", "success");
          })
          .catch(() => showToast("Failed to copy share text.", "error"));
      }
    }
  }

  function editNote(noteId: string) {
    // TODO: Implement server-side note editing API
    showToast("Edit feature coming soon!", "info");
  }

  async function toggleFavorite(noteId: string) {
    // TODO: Implement server-side favorite toggling API
    const button = document.querySelector(
      `[onclick="toggleFavorite('${noteId}')"]`,
    );
    button?.classList.toggle("favorited");
    const svg = button?.querySelector("svg");
    if (svg) {
      svg.setAttribute(
        "fill",
        button?.classList.contains("favorited") ? "currentColor" : "none",
      );
    }
    showToast("Favorite feature coming soon!", "info");
  }

  function showToast(
    message: string,
    type: "success" | "error" | "info" = "info",
  ) {
    const toast = document.createElement("div");
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed; 
      top: 20px; 
      right: 20px; 
      padding: 12px 16px; 
      border-radius: 8px; 
      z-index: 1000;
      font-family: var(--font-family-secondary);
      font-size: var(--font-size-sm);
    `;

    if (type === "success") {
      toast.style.background = "var(--color-success)";
      toast.style.color = "white";
    } else if (type === "error") {
      toast.style.background = "var(--color-error)";
      toast.style.color = "white";
    } else {
      toast.style.background = "var(--color-info)";
      toast.style.color = "white";
    }

    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // Make functions globally available
  (window as any).copyNote = copyNote;
  (window as any).shareNote = shareNote;
  (window as any).editNote = editNote;
  (window as any).toggleFavorite = toggleFavorite;
</script>

<style>
  .note-card {
    background-color: var(--kindle-color-surface);
    background-image: var(--texture-paper);
    background-size: var(--texture-paper-size);
    border: 1px solid var(--kindle-color-border);
    border-radius: var(--kindle-border-radius);
    padding: var(--kindle-space-lg);
    transition: all 0.2s ease-out;
    position: relative;
  }

  .note-card:hover {
    border-color: var(--kindle-color-accent);
    box-shadow: var(--kindle-shadow-card);
  }

  /* T018, T019: Association display styles */
  .note-associated {
    margin-left: 2rem;
    margin-top: 0.75rem;
    border-left: 3px solid var(--kindle-color-accent-secondary);
    padding-left: 1rem;
    background: var(--kindle-color-surface-hover);
  }

  .note-standalone {
    /* Full width, normal display */
    margin-bottom: 1.5rem;
  }

  /* T020: Visual connector for associated notes */
  .note-associated::before {
    content: "";
    position: absolute;
    left: -3px;
    top: -0.75rem;
    width: 3px;
    height: 0.75rem;
    background: var(--kindle-color-accent-secondary);
    opacity: 0.3;
  }

  .note-card-compact {
    padding: var(--kindle-space-md);
  }

  /* Type-specific styling */
  .note-type-highlight {
    border-left: 4px solid var(--kindle-color-accent);
  }

  /* Highlight with associated note gets subtle visual indicator */
  .note-type-highlight.has-associated-note {
    border-bottom: 2px solid var(--kindle-color-accent-secondary);
    margin-bottom: 0;
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
  }

  .note-type-note {
    border-left: 4px solid var(--kindle-color-accent-secondary);
  }

  .note-type-bookmark {
    border-left: 4px solid var(--kindle-color-accent);
  }

  .note-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--kindle-space-md);
    gap: var(--kindle-space-sm);
  }

  .note-type {
    display: flex;
    align-items: center;
    gap: var(--kindle-space-xs);
    font-family: var(--kindle-font-sans);
    font-size: var(--kindle-size-text-sm);
    font-weight: 500;
    color: var(--kindle-color-text-secondary);
    text-transform: capitalize;
  }

  .note-type svg {
    width: 16px;
    height: 16px;
  }

  .note-type-highlight .note-type {
    color: var(--kindle-color-accent);
  }

  .note-type-note .note-type {
    color: var(--kindle-color-accent-secondary);
  }

  .note-type-bookmark .note-type {
    color: var(--kindle-color-accent);
  }

  .note-meta {
    display: flex;
    gap: var(--kindle-space-sm);
    font-family: var(--kindle-font-sans);
    font-size: var(--kindle-size-text-xs);
    color: var(--kindle-color-text-muted);
    text-align: right;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .note-meta span:not(:last-child)::after {
    content: "â€¢";
    margin-left: var(--kindle-space-sm);
  }

  .note-book-info {
    display: flex;
    align-items: center;
    gap: var(--kindle-space-xs);
    font-family: var(--kindle-font-sans);
    font-size: var(--kindle-size-text-sm);
    color: var(--kindle-color-text-muted);
    margin-bottom: var(--kindle-space-md);
  }

  .note-content {
    margin-bottom: var(--kindle-space-md);
  }

  .note-text {
    font-family: var(--kindle-font-serif);
    font-size: var(--kindle-size-text-base);
    line-height: var(--kindle-line-height-reading);
    color: var(--kindle-color-text);
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .note-text.editing {
    background: var(--kindle-color-surface-hover);
    padding: var(--kindle-space-sm);
    border-radius: var(--kindle-border-radius);
    outline: 2px solid var(--kindle-color-accent);
  }

  .bookmark-placeholder {
    font-family: var(--kindle-font-sans);
    font-style: italic;
    color: var(--kindle-color-text-muted);
    margin: 0;
  }

  .note-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--kindle-space-xs);
    margin-bottom: var(--kindle-space-md);
  }

  .tag {
    background: var(--kindle-color-surface-hover);
    color: var(--kindle-color-text-secondary);
    font-family: var(--kindle-font-sans);
    font-size: var(--kindle-size-text-xs);
    padding: var(--kindle-space-xs) var(--kindle-space-sm);
    border-radius: var(--kindle-border-radius-full);
    border: 1px solid var(--kindle-color-border);
    transition: all 0.2s ease-out;
  }

  .tag:hover {
    background: var(--kindle-color-accent);
    color: white;
    cursor: pointer;
  }

  .note-actions {
    display: flex;
    align-items: center;
    gap: var(--kindle-space-xs);
  }

  .action-btn {
    background: none;
    border: none;
    color: var(--kindle-color-text-muted);
    cursor: pointer;
    padding: var(--kindle-space-xs);
    border-radius: var(--kindle-border-radius);
    transition: all 0.2s ease-out;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .action-btn:hover {
    color: var(--kindle-color-text);
    background: var(--kindle-color-surface-hover);
  }

  .action-btn svg {
    width: 16px;
    height: 16px;
  }

  .favorite-btn.favorited {
    color: var(--kindle-color-accent);
  }

  .favorite-btn.favorited svg {
    fill: currentColor;
  }

  .action-spacer {
    flex: 1;
  }

  .save-btn {
    position: absolute;
    top: var(--kindle-space-sm);
    right: var(--kindle-space-sm);
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .note-card {
      padding: var(--kindle-space-md);
    }

    /* T041: Reduce indentation on mobile */
    .note-associated {
      margin-left: 1rem;
    }

    .note-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--kindle-space-xs);
    }

    .note-meta {
      flex-direction: column;
      text-align: left;
      gap: var(--kindle-space-xs);
    }

    .note-meta span::after {
      display: none;
    }
  }

  /* Print styles */
  @media print {
    .note-actions {
      display: none;
    }

    .note-card {
      border: 1px solid #ccc;
      margin-bottom: 1rem;
      page-break-inside: avoid;
    }
  }
</style>
