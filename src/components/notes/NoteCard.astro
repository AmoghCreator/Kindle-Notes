---
// Note card component for displaying individual notes
import type { Note, NoteType } from '../../lib/types';

export interface Props {
  note: Note;
  bookTitle?: string;
  showBookInfo?: boolean;
  compact?: boolean;
  editable?: boolean;
  class?: string;
}

const {
  note,
  bookTitle,
  showBookInfo = false,
  compact = false,
  editable = false,
  class: className = ''
} = Astro.props;

// Format the note creation date
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('en-US', {
    month: 'short',
    day: 'numeric',
    year: date.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined,
    hour: 'numeric',
    minute: '2-digit'
  }).format(date);
};

// Get icon for note type
const getTypeIcon = (type: NoteType) => {
  switch (type) {
    case 'highlight':
      return 'M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z';
    case 'note':
      return 'M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 011-1h1a2 2 0 100-4H7a1 1 0 01-1-1V8a1 1 0 011-1h3a1 1 0 001-1V4z';
    case 'bookmark':
      return 'M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z';
    default:
      return '';
  }
};

const typeIcon = getTypeIcon(note.type);
---

<article class={`note-card note-type-${note.type} ${compact ? 'note-card-compact' : ''} ${className}`}>
  <header class="note-header">
    <div class="note-type">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d={typeIcon} />
      </svg>
      <span class="note-type-label">{note.type}</span>
    </div>
    
    <div class="note-meta">
      {note.page && (
        <span class="note-page">Page {note.page}</span>
      )}
      {note.location && (
        <span class="note-location">Location {note.location}</span>
      )}
      <time class="note-date" datetime={note.createdAt.toISOString()}>
        {formatDate(note.createdAt)}
      </time>
    </div>
  </header>

  {showBookInfo && bookTitle && (
    <div class="note-book-info">
      <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
        <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
      </svg>
      <span class="book-title">{bookTitle}</span>
    </div>
  )}

  <div class="note-content">
    {note.type === 'bookmark' ? (
      <p class="bookmark-placeholder">Bookmark saved</p>
    ) : (
      <div 
        class="note-text" 
        data-note-id={note.id}
        contenteditable={editable}
        suppressContentEditableWarning={true}
      >
        {note.content}
      </div>
    )}
  </div>

  {note.tags && note.tags.length > 0 && (
    <div class="note-tags">
      {note.tags.map(tag => (
        <span class="tag" key={tag}>#{tag}</span>
      ))}
    </div>
  )}

  <footer class="note-actions">
    <button 
      class="action-btn"
      onclick={`copyNote('${note.id}')`}
      aria-label="Copy note"
      title="Copy to clipboard"
    >
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
        <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
      </svg>
    </button>

    <button 
      class="action-btn"
      onclick={`shareNote('${note.id}')`}
      aria-label="Share note"
      title="Share note"
    >
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/>
        <polyline points="16,6 12,2 8,6"/>
        <line x1="12" y1="2" x2="12" y2="15"/>
      </svg>
    </button>

    {editable && (
      <button 
        class="action-btn"
        onclick={`editNote('${note.id}')`}
        aria-label="Edit note"
        title="Edit note"
      >
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
          <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
        </svg>
      </button>
    )}

    <div class="action-spacer"></div>
    
    <button 
      class="action-btn favorite-btn"
      onclick={`toggleFavorite('${note.id}')`}
      aria-label="Toggle favorite"
      title="Add to favorites"
    >
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
      </svg>
    </button>
  </footer>
</article>

<script>
  function copyNote(noteId: string) {
    const noteElement = document.querySelector(`[data-note-id="${noteId}"]`);
    if (noteElement) {
      const text = noteElement.textContent || '';
      navigator.clipboard.writeText(text).then(() => {
        showToast('Note copied to clipboard!', 'success');
      }).catch(() => {
        showToast('Failed to copy note', 'error');
      });
    }
  }

  function shareNote(noteId: string) {
    const noteElement = document.querySelector(`[data-note-id="${noteId}"]`);
    if (noteElement) {
      const text = noteElement.textContent || '';
      const shareData = {
        title: 'Note from my reading',
        text: text,
        url: `${window.location.origin}/notes/${noteId}`
      };

      if (navigator.share) {
        navigator.share(shareData).catch(console.error);
      } else {
        navigator.clipboard.writeText(`${shareData.text}\n\n${shareData.url}`).then(() => {
          showToast('Note and link copied to clipboard!', 'success');
        }).catch(console.error);
      }
    }
  }

  function editNote(noteId: string) {
    const noteElement = document.querySelector(`[data-note-id="${noteId}"]`);
    if (noteElement) {
      noteElement.focus();
      
      // Enable editing mode
      noteElement.setAttribute('contenteditable', 'true');
      noteElement.classList.add('editing');
      
      // Add save button
      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Save';
      saveBtn.className = 'btn btn-sm btn-primary save-btn';
      saveBtn.onclick = () => saveNoteEdit(noteId);
      
      const noteCard = noteElement.closest('.note-card');
      if (noteCard) {
        noteCard.appendChild(saveBtn);
      }
    }
  }

  function saveNoteEdit(noteId: string) {
    const noteElement = document.querySelector(`[data-note-id="${noteId}"]`);
    if (noteElement) {
      const newContent = noteElement.textContent || '';
      
      // Save to backend
      fetch(`/api/notes/${noteId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: newContent })
      }).then(response => {
        if (response.ok) {
          showToast('Note updated!', 'success');
          
          // Exit editing mode
          noteElement.setAttribute('contenteditable', 'false');
          noteElement.classList.remove('editing');
          
          // Remove save button
          const saveBtn = noteElement.closest('.note-card')?.querySelector('.save-btn');
          saveBtn?.remove();
        } else {
          showToast('Failed to update note', 'error');
        }
      }).catch(() => {
        showToast('Failed to update note', 'error');
      });
    }
  }

  function toggleFavorite(noteId: string) {
    const button = document.querySelector(`[onclick="toggleFavorite('${noteId}')"]`);
    const isFavorited = button?.classList.contains('favorited');
    
    fetch(`/api/notes/${noteId}/favorite`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ favorite: !isFavorited })
    }).then(response => {
      if (response.ok) {
        button?.classList.toggle('favorited');
        const svg = button?.querySelector('svg');
        if (svg) {
          svg.setAttribute('fill', button.classList.contains('favorited') ? 'currentColor' : 'none');
        }
        showToast(isFavorited ? 'Removed from favorites' : 'Added to favorites', 'success');
      }
    }).catch(console.error);
  }

  function showToast(message: string, type: 'success' | 'error') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed; 
      top: 20px; 
      right: 20px; 
      padding: 12px 16px; 
      border-radius: 8px; 
      z-index: 1000;
      font-family: var(--font-family-secondary);
      font-size: var(--font-size-sm);
    `;
    
    if (type === 'success') {
      toast.style.background = 'var(--color-success)';
      toast.style.color = 'white';
    } else {
      toast.style.background = 'var(--color-error)';
      toast.style.color = 'white';
    }
    
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // Make functions globally available
  window.copyNote = copyNote;
  window.shareNote = shareNote;
  window.editNote = editNote;
  window.toggleFavorite = toggleFavorite;
</script>

<style>
  .note-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-lg);
    padding: var(--space-lg);
    transition: all 0.2s var(--easing-ease-out);
    position: relative;
  }
  
  .note-card:hover {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-sm);
  }
  
  .note-card-compact {
    padding: var(--space-md);
  }
  
  /* Type-specific styling */
  .note-type-highlight {
    border-left: 4px solid var(--color-warning);
  }
  
  .note-type-note {
    border-left: 4px solid var(--color-info);
  }
  
  .note-type-bookmark {
    border-left: 4px solid var(--color-success);
  }
  
  .note-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-md);
    gap: var(--space-sm);
  }
  
  .note-type {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-family: var(--font-family-secondary);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-secondary);
    text-transform: capitalize;
  }
  
  .note-type svg {
    width: 16px;
    height: 16px;
  }
  
  .note-type-highlight .note-type {
    color: var(--color-warning);
  }
  
  .note-type-note .note-type {
    color: var(--color-info);
  }
  
  .note-type-bookmark .note-type {
    color: var(--color-success);
  }
  
  .note-meta {
    display: flex;
    gap: var(--space-sm);
    font-family: var(--font-family-secondary);
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    text-align: right;
    flex-wrap: wrap;
    justify-content: flex-end;
  }
  
  .note-meta span:not(:last-child)::after {
    content: 'â€¢';
    margin-left: var(--space-sm);
  }
  
  .note-book-info {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-family: var(--font-family-secondary);
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    margin-bottom: var(--space-md);
  }
  
  .note-content {
    margin-bottom: var(--space-md);
  }
  
  .note-text {
    font-family: var(--font-family-primary);
    font-size: var(--font-size-base);
    line-height: var(--line-height-relaxed);
    color: var(--color-text-primary);
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  
  .note-text.editing {
    background: var(--color-surface-hover);
    padding: var(--space-sm);
    border-radius: var(--border-radius-sm);
    outline: 2px solid var(--color-primary);
  }
  
  .bookmark-placeholder {
    font-family: var(--font-family-secondary);
    font-style: italic;
    color: var(--color-text-muted);
    margin: 0;
  }
  
  .note-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
    margin-bottom: var(--space-md);
  }
  
  .tag {
    background: var(--color-surface-hover);
    color: var(--color-text-secondary);
    font-family: var(--font-family-secondary);
    font-size: var(--font-size-xs);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--border-radius-full);
    border: 1px solid var(--color-border);
    transition: all 0.2s var(--easing-ease-out);
  }
  
  .tag:hover {
    background: var(--color-primary);
    color: white;
    cursor: pointer;
  }
  
  .note-actions {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }
  
  .action-btn {
    background: none;
    border: none;
    color: var(--color-text-muted);
    cursor: pointer;
    padding: var(--space-xs);
    border-radius: var(--border-radius-sm);
    transition: all 0.2s var(--easing-ease-out);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .action-btn:hover {
    color: var(--color-text-primary);
    background: var(--color-surface-hover);
  }
  
  .action-btn svg {
    width: 16px;
    height: 16px;
  }
  
  .favorite-btn.favorited {
    color: var(--color-warning);
  }
  
  .favorite-btn.favorited svg {
    fill: currentColor;
  }
  
  .action-spacer {
    flex: 1;
  }
  
  .save-btn {
    position: absolute;
    top: var(--space-sm);
    right: var(--space-sm);
  }
  
  /* Responsive design */
  @media (max-width: 768px) {
    .note-card {
      padding: var(--space-md);
    }
    
    .note-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-xs);
    }
    
    .note-meta {
      flex-direction: column;
      text-align: left;
      gap: var(--space-xs);
    }
    
    .note-meta span::after {
      display: none;
    }
  }
  
  /* Print styles */
  @media print {
    .note-actions {
      display: none;
    }
    
    .note-card {
      border: 1px solid #ccc;
      margin-bottom: 1rem;
      page-break-inside: avoid;
    }
  }
</style>